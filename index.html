<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Zmanim Lookup</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f4f8;
            color: #333;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
        }
        form, #results, #chart-container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .zman-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .zman-name {
            font-weight: bold;
            color: #2c3e50;
        }
        .zman-time {
            color: #34495e;
        }
        #zmanim-select {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .zman-checkbox {
            display: flex;
            align-items: center;
        }
        .zman-checkbox input {
            margin-right: 5px;
            width: auto;
        }
        #cities-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .city-input {
            flex: 1;
        }
        .select-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .select-buttons button {
            flex: 1;
        }
        #chart-container {
            height: 400px;
        }
        /* Style for the Zmanim Results Container */
.zmanim-results-title {
    font-size: 1.5em;
    font-weight: bold;
    margin-bottom: 10px;
}

.zmanim-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 10px;
}

.zmanim-name {
    font-weight: bold;
    color: #2c3e50;
}

.zmanim-time {
    color: #34495e;
}

/* Distinct style for the current time marker */
.current-time-marker {
    font-weight: bold;
    font-size: 1.2em;
    color: #ffffff;
    background-color: #2980b9;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Leaderboard table */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
table th, table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}
table th {
    background-color: #f2f2f2;
    font-weight: bold;
}

/* Leaderboard table container */
#leaderboard-results {
    max-height: 2000px;  /* Set a max height */
    overflow-y: auto;  /* Scroll vertically if content exceeds the height */
    background-color: #ffffff;  /* Make sure it's white */
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

#leaderboard-map {
    height: 400px;
    width: 100%;
    margin-top: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
    </style>
</head>
<body>
    <h1>Advanced Zmanim Lookup</h1>
    <div id="today-zmanim-section" style="margin-bottom: 30px;">
        <h2>Today's Zmanim</h2>
        <button id="zmanim-today-btn">Get Today's Zmanim</button>
        <div id="today-zmanim-results" class="zmanim-results-container"></div>
    </div>
    <form id="zmanim-form">
        <div id="map" style="height: 400px; margin-bottom: 20px;"></div>
        <div id="cities-container">
            <div class="city-input">
                <input type="text" placeholder="Enter city name" required>
                <button type="button" class="remove-city" style="display:none;">Remove</button>
            </div>

        </div>
        <button type="button" id="add-city">Add City</button>
        <div class="form-group">
            <label for="start-date">Start Date:</label>
            <input type="date" id="start-date" required>
        </div>
        <div class="form-group">
            <label for="end-date">End Date (Optional):</label>
            <input type="date" id="end-date">
        </div>
        <div class="form-group">
            <label>Select Zmanim:</label>
            <div class="select-buttons">
                <button type="button" id="select-all">Select All</button>
                <button type="button" id="deselect-all">Deselect All</button>
            </div>
            <div id="zmanim-select"></div>
        </div>
        <button type="submit">Get Zmanim</button>
    </form>
    <div id="results"></div>
    <div id="chart-container">
        <div id="zmanim-chart"></div>

    <!-- Leaderboard Section -->
<!-- Leaderboard Section -->
<div id="leaderboard">
    <h2>Zmanim Leaderboard</h2>
    <button id="fetch-leaderboard">Generate Leaderboard</button>
    <div id="leaderboard-results">
        <table>
            <thead>
                <tr>
                    <th>Zman</th>
                    <th>City</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                <!-- Results will be populated here -->
            </tbody>
        </table>
    </div>
    <div id="leaderboard-map"></div>
</div>

    <script>

        let chart; // Global variable to hold the chart instance
        const zmanim = [
            "chatzotNight", "alotHaShachar", "misheyakir", "misheyakirMachmir", "dawn", "sunrise", 
            "sofZmanShmaMGA19Point8", "sofZmanShmaMGA16Point1", "sofZmanShmaMGA", "sofZmanShma", 
            "sofZmanTfillaMGA19Point8", "sofZmanTfillaMGA16Point1", "sofZmanTfillaMGA", "sofZmanTfilla",
            "chatzot", "minchaGedola", "minchaGedolaMGA", "minchaKetana", "minchaKetanaMGA", 
            "plagHaMincha", "sunset", "beinHaShmashos", "dusk", "tzeit7083deg", "tzeit85deg", 
            "tzeit42min", "tzeit50min", "tzeit72min"
        ];

        const zmanimLabels = {
            "chatzotNight": "Chatzot Night",
            "alotHaShachar": "Alot HaShachar",
            "misheyakir": "Misheyakir",
            "misheyakirMachmir": "Misheyakir Machmir",
            "dawn": "Dawn",
            "sunrise": "Sunrise",
            "sofZmanShmaMGA19Point8": "Sof Zman Shma (MGA 19.8°)",
            "sofZmanShmaMGA16Point1": "Sof Zman Shma (MGA 16.1°)",
            "sofZmanShmaMGA": "Sof Zman Shma (MGA)",
            "sofZmanShma": "Sof Zman Shma",
            "sofZmanTfillaMGA19Point8": "Sof Zman Tfilla (MGA 19.8°)",
            "sofZmanTfillaMGA16Point1": "Sof Zman Tfilla (MGA 16.1°)",
            "sofZmanTfillaMGA": "Sof Zman Tfilla (MGA)",
            "sofZmanTfilla": "Sof Zman Tfilla",
            "chatzot": "Chatzot",
            "minchaGedola": "Mincha Gedola",
            "minchaGedolaMGA": "Mincha Gedola (MGA)",
            "minchaKetana": "Mincha Ketana",
            "minchaKetanaMGA": "Mincha Ketana (MGA)",
            "plagHaMincha": "Plag HaMincha",
            "sunset": "Sunset",
            "beinHaShmashos": "Bein HaShmashos",
            "dusk": "Dusk",
            "tzeit7083deg": "Tzeit 70.83°",
            "tzeit85deg": "Tzeit 85°",
            "tzeit42min": "Tzeit 42 min",
            "tzeit50min": "Tzeit 50 min",
            "tzeit72min": "Tzeit 72 min"
        };


        document.addEventListener("DOMContentLoaded", function() {
    console.log('Initializing map and form.');
    
    const map = L.map('map').setView([41.85003, -87.65005], 10); // Default to Chicago
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let reverseGeocodedCity = ""; // Variable to store the reverse-geocoded city name

// Handle map click event
map.on('click', async function(e) {
    const lat = e.latlng.lat.toFixed(4);
    const lng = e.latlng.lng.toFixed(4);
    const cityInput = document.querySelector('#cities-container input');

    if (cityInput) {
        cityInput.value = `${lat}, ${lng}`;

        // Automatically fetch Zmanim data after updating the input
        await updateZmanimData(lat, lng);
    }
});
});

async function updateZmanimData(lat, lng) {
    try {
        // Fetch city name using reverse geocoding
        const cityName = await getCityFromLatLong(lat, lng);

        // Log the coordinates and the reverse-geocoded city name
        console.log(`Fetching Zmanim data for lat: ${lat}, lng: ${lng}, city: ${cityName}`);

        // Fetch Zmanim data
        const zmanimData = await fetchZmanimForLocation(lat, lng);

        // Construct the location label with lat/long and city name
        const locationLabel = `Location: ${lat}, ${lng} (${cityName})`;

        // Update the display with Zmanim data and chart
        displayResults([zmanimData], [locationLabel], zmanimData.date.start, zmanimData.date.end);
        const selectedZmanim = Array.from(document.querySelectorAll('input[name="zmanim"]:checked')).map(cb => cb.value);
        createChart([zmanimData], [locationLabel], zmanimData.date.start, zmanimData.date.end, selectedZmanim);
    } catch (error) {
        console.error("Error fetching Zmanim data:", error);
    }
}

async function fetchZmanimForLocation(lat, lng) {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value || startDate; // Handle single date

    const params = new URLSearchParams({
        cfg: 'json',
        latitude: lat,  // Use lat/long
        longitude: lng,
        start: startDate,
        end: endDate,
        b: '18',
        M: 'on',
        m: '50'
    });

    const apiUrl = `https://www.hebcal.com/zmanim?${params}`;
    console.log(`Calling Hebcal API with lat/long: ${apiUrl}`);

    const response = await fetch(apiUrl);
    if (!response.ok) {
        const errorData = await response.json();
        console.error('API Error:', errorData);
        throw new Error('Failed to fetch Zmanim data');
    }

    const data = await response.json();
    console.log('Received Zmanim data:', data);
    
    if (startDate === endDate) {
        // Handle single date format by assigning all times to the single date
        data.times = Object.fromEntries(
            Object.entries(data.times).map(([zman, time]) => [zman, { [startDate]: time }])
        );
    }
    
    return data;
}

async function getCityFromLatLong(lat, lng) {
    console.log(`Reverse geocoding for lat: ${lat}, lng: ${lng}`);

    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`);
    const data = await response.json();

    if (data && data.address) {
        console.log(`Reverse geocoding result:`, data.address);
        return data.address.city || data.address.town || data.address.village || "Unknown Location";
    } else {
        console.warn(`No city found for lat: ${lat}, lng: ${lng}`);
        return "Unknown Location";
    }
}

function populateZmanimCheckboxes() {
    const container = document.getElementById('zmanim-select');
    zmanim.forEach(zman => {
        const checkbox = document.createElement('div');
        checkbox.className = 'zman-checkbox';
        checkbox.innerHTML = `
            <input type="checkbox" id="${zman}" name="zmanim" value="${zman}">
            <label for="${zman}">${zmanimLabels[zman]}</label>
        `;
        container.appendChild(checkbox);
    });
    console.log('Zmanim checkboxes populated.');
}

populateZmanimCheckboxes();

document.getElementById('select-all').addEventListener('click', () => {
    document.querySelectorAll('input[name="zmanim"]').forEach(cb => cb.checked = true);
    console.log('All Zmanim checkboxes selected.');
});

document.getElementById('deselect-all').addEventListener('click', () => {
    document.querySelectorAll('input[name="zmanim"]').forEach(cb => cb.checked = false);
    console.log('All Zmanim checkboxes deselected.');
});

document.getElementById('add-city').addEventListener('click', () => {
    const citiesContainer = document.getElementById('cities-container');
    const newCity = document.createElement('div');
    newCity.className = 'city-input';
    newCity.innerHTML = `
        <input type="text" placeholder="Enter city name" required>
        <button type="button" class="remove-city">Remove</button>
    `;
    citiesContainer.appendChild(newCity);
    console.log('New city input added.');

    newCity.querySelector('.remove-city').addEventListener('click', () => {
        citiesContainer.removeChild(newCity);
        console.log('City input removed.');
    });
});

document.getElementById('zmanim-form').addEventListener('submit', async (e) => {
    e.preventDefault(); // Prevent the form from resetting
    console.log('Form submitted, fetching Zmanim.');

    const cityInputs = Array.from(document.querySelectorAll('#cities-container input')).map(input => input.value);
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value || startDate; // Use startDate if endDate is not provided
    const selectedZmanim = Array.from(document.querySelectorAll('input[name="zmanim"]:checked')).map(cb => cb.value);
    const resultsDiv = document.getElementById('results');

    console.log(`Fetching Zmanim for inputs: ${cityInputs}, from ${startDate} to ${endDate}`);
    
    resultsDiv.innerHTML = '<p>Loading...</p>';

    try {
        const zmanimData = await Promise.all(cityInputs.map(async (input) => {
            const isZipCode = /^\d{5}$/.test(input);

            if (isZipCode) {
                // Fetch Zmanim using the ZIP code parameter
                return {
                    zmanimData: await fetchZmanimByZipCode(input),
                    locationLabel: `ZIP Code: ${input}`
                };
            } else if (input.includes(',')) {
                // Treat as lat/long pair
                const [lat, lng] = input.split(',').map(coord => coord.trim());
                const cityName = await getCityFromLatLong(lat, lng);
                return {
                    zmanimData: await fetchZmanimForLocation(lat, lng),
                    locationLabel: `${lat}, ${lng} (${cityName})`
                };
            } else {
                // Treat as city name and fetch lat/long
                const latLongData = await fetchLatLongForCity(input);
                return {
                    zmanimData: await fetchZmanimForLocation(latLongData.lat, latLongData.lng),
                    locationLabel: `${latLongData.lat}, ${latLongData.lng} (${input})`
                };
            }
        }));

        // Extract Zmanim data and location labels for display
        const zmanimArray = zmanimData.map(data => data.zmanimData);
        const locationLabels = zmanimData.map(data => data.locationLabel);

        console.log('Zmanim data fetched:', zmanimArray);

        // Display results and create chart
        displayResults(zmanimArray, locationLabels, startDate, endDate, selectedZmanim);
        createChart(zmanimArray, locationLabels, startDate, endDate, selectedZmanim);
    } catch (error) {
        resultsDiv.innerHTML = `<p>Error: ${error.message}</p>`;
        console.error('Error fetching Zmanim:', error);
    }
});


// Fetch Zmanim using ZIP code
async function fetchZmanimByZipCode(zipCode) {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value || startDate; // Handle single date

    const params = new URLSearchParams({
        cfg: 'json',
        zip: zipCode,  // Use ZIP code
        start: startDate,
        end: endDate,
        b: '18',
        M: 'on',
        m: '50'
    });

    const apiUrl = `https://www.hebcal.com/zmanim?${params}`;
    console.log(`Calling Hebcal API with ZIP code: ${apiUrl}`);

    const response = await fetch(apiUrl);
    if (!response.ok) {
        const errorData = await response.json();
        console.error('API Error:', errorData);
        throw new Error('Failed to fetch Zmanim data');
    }

    const data = await response.json();
    console.log('Received Zmanim data:', data);

    if (startDate === endDate) {
        // Handle single date format by assigning all times to the single date
        data.times = Object.fromEntries(
            Object.entries(data.times).map(([zman, time]) => [zman, { [startDate]: time }])
        );
    }

    return data;
}

async function fetchLatLongForCity(city) {
    // You can implement this function using an API or a pre-defined map to get lat/long from a city name
    // For example:
    const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${city}&format=json&limit=1`);
    const data = await response.json();
    if (data && data.length > 0) {
        return { lat: data[0].lat, lng: data[0].lon };
    }
    return { lat: 0, lng: 0 }; // Default if no result found
}

async function fetchZmanimForDateRange(cityOrLatLng, startDate, endDate, selectedZmanim) {
    let params;

    if (typeof cityOrLatLng === 'string' && cityOrLatLng.includes(',')) {
        // Treat as lat/long if a comma is present
        const [latitude, longitude] = cityOrLatLng.split(',').map(coord => coord.trim());
        params = new URLSearchParams({
            cfg: 'json',
            latitude: latitude,
            longitude: longitude,
            start: startDate,
            end: endDate,
            b: '18',
            M: 'on',
            m: '50'
        });
    } else {
        // Treat as city name
        params = new URLSearchParams({
            cfg: 'json',
            city: cityOrLatLng,
            start: startDate,
            end: endDate,
            b: '18',
            M: 'on',
            m: '50'
        });
    }

    const response = await fetch(`https://www.hebcal.com/zmanim?${params}`);
    const data = await response.json();

    // Debugging: Log the raw data returned from the API
    console.log('Raw Zmanim Data:', data);

    // Ensure the data structure is uniform, whether for single or multiple dates
    if (!data.times || Object.keys(data.times).length === 0) {
        return { times: {} }; // Return an empty times object if no data is found
    }

    if (startDate === endDate) {
        data.times = Object.fromEntries(
            Object.entries(data.times).map(([zman, time]) => [zman, { [startDate]: time }])
        );
    }

    return data;
}

function displayResults(zmanimData, cities, startDate, endDate) {
    const selectedZmanim = Array.from(document.querySelectorAll('input[name="zmanim"]:checked')).map(cb => cb.value);
    const resultsDiv = document.getElementById('results');
    
    if (!zmanimData || zmanimData.length === 0) {
        resultsDiv.innerHTML = '<p>No Zmanim data available.</p>';
        return;
    }

    if (!selectedZmanim || selectedZmanim.length === 0) {
        resultsDiv.innerHTML = '<p>No Zmanim selected.</p>';
        return;
    }

    let html = `<h2>Zmanim Comparison (${startDate || 'N/A'} to ${endDate || 'N/A'})</h2>`;

    cities.forEach((locationLabel, index) => {
        const cityData = zmanimData[index];
        html += `<h3>${locationLabel}</h3>`;  // Display lat, long, and city name

        if (cityData && cityData.times) {
            const times = cityData.times;
            const timeZone = cityData.location?.tzid || 'UTC'; // Default to UTC if time zone is not provided
            let cityHtml = '<ul>';
            selectedZmanim.forEach(zman => {
                if (times[zman]) {
                    Object.entries(times[zman]).forEach(([date, time]) => {
                        if (time) {
                            const zmanTime = new Date(time); // Create date object from time
                            const formattedTime = zmanTime.toLocaleString('en-US', { 
                                timeZone: timeZone, // Convert to local time zone
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                            cityHtml += `<li>${formatZmanName(zman)} (${date}): ${formattedTime} (${timeZone})</li>`;
                        }
                    });
                } else {
                    cityHtml += `<li>${formatZmanName(zman)}: No data available</li>`;
                }
            });
            cityHtml += '</ul>';
            html += cityHtml;
        } else {
            html += '<p>No data available for this location.</p>';
        }
    });

    resultsDiv.innerHTML = html;
}

function createChart(zmanimData, cities, startDate, endDate, selectedZmanim) {
    if (chart) {
        chart.destroy();  // Destroy the previous chart instance
    }

    const series = [];
    let minTime = Infinity;
    let maxTime = -Infinity;

    selectedZmanim.forEach(zman => {
        cities.forEach((locationLabel, cityIndex) => {
            const data = [];
            const cityData = zmanimData[cityIndex];
            const timeZone = cityData.location?.tzid || 'UTC';  // Use the time zone provided or default to UTC

            if (cityData.times[zman]) {
                Object.entries(cityData.times[zman]).forEach(([date, time]) => {
                    if (time) {
                        const parsedDate = new Date(date + 'T00:00:00'); // Parse the date part
                        const zmanTime = new Date(time); // Zman time as Date object

                        // Convert time to the appropriate time zone
                        const formattedTime = new Date(zmanTime.toLocaleString('en-US', {
                            timeZone: timeZone
                        }));

                        // Calculate the time in hours
                        const timeInHours = formattedTime.getHours() + formattedTime.getMinutes() / 60;
                        data.push([parsedDate.getTime(), timeInHours]);

                        // Update min and max times for y-axis range
                        if (timeInHours < minTime) minTime = timeInHours;
                        if (timeInHours > maxTime) maxTime = timeInHours;
                    }
                });
            }

            if (data.length > 0) {
                series.push({
                    name: `${formatZmanName(zman)} - ${locationLabel}`,  // Correctly label the chart with the city
                    data: data.sort((a, b) => a[0] - b[0]),
                    type: startDate === endDate ? 'scatter' : 'line', // Use scatter for single date
                    markers: {
                        size: 8,
                    },
                    stroke: {
                        width: startDate === endDate ? 0 : 2, // No line for single date
                    }
                });
            }
        });
    });

    const padding = 0.5;
    minTime = Math.max(minTime - padding, 0);
    maxTime = Math.min(maxTime + padding, 24);

    const options = {
        chart: {
            type: 'line',
            height: 400,
            toolbar: {
                show: true
            }
        },
        series: series,
        xaxis: {
            type: 'datetime',
            title: {
                text: 'Date'
            },
            labels: {
                format: 'yyyy-MM-dd'
            },
            tickAmount: series[0]?.data.length > 1 ? undefined : 1
        },
        yaxis: {
            title: {
                text: 'Time'
            },
            min: minTime,
            max: maxTime,
            labels: {
                formatter: function(value) {
                    const hours = Math.floor(value);
                    const minutes = Math.round((value - hours) * 60);
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const formattedHours = hours % 12 || 12;
                    return `${formattedHours}:${minutes < 10 ? '0' : ''}${minutes} ${ampm}`;
                }
            },
            tickAmount: 12
        },
        stroke: {
            curve: 'smooth'
        },
        markers: {
            size: 6,
        },
        tooltip: {
            x: {
                format: 'yyyy-MM-dd'
            },
            y: {
                formatter: function(value) {
                    const hours = Math.floor(value);
                    const minutes = Math.round((value - hours) * 60);
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const formattedHours = hours % 12 || 12;
                    return `${formattedHours}:${minutes < 10 ? '0' : ''}${minutes} ${ampm}`;
                }
            }
        },
        grid: {
            show: true,
            xaxis: {
                lines: {
                    show: true
                }
            },
            yaxis: {
                lines: {
                    show: true
                }
            }
        }
    };

    chart = new ApexCharts(document.querySelector("#zmanim-chart"), options);
    chart.render();
}

        function formatZmanName(zman) {
            return zman
                .replace(/([A-Z])/g, ' $1')
                .split(/(?=[A-Z])/)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ')
                .trim();
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function displayTodayZmanim(zmanimData, locationLabel, date) {
    const resultsContainer = document.getElementById('today-zmanim-results');
    resultsContainer.innerHTML = ''; // Clear previous results

    // Create title
    const title = document.createElement('div');
    title.className = 'zmanim-results-title';
    title.textContent = `Zmanim for ${locationLabel} on ${date}`;
    resultsContainer.appendChild(title);

    // Get current time
    const currentTime = new Date();

    // Array to hold all Zmanim
    let zmanimList = [];

    // Display Zmanim and highlight based on current time
    if (zmanimData && zmanimData.times) {
        Object.entries(zmanimData.times).forEach(([zman, zmanObject]) => {
            if (zmanObject) {
                const zmanTimeStr = Object.values(zmanObject)[0]; // Get the first date/time pair
                const zmanTime = new Date(zmanTimeStr); // Convert to Date object

                if (!isNaN(zmanTime.getTime())) {
                    zmanimList.push({ name: formatZmanName(zman), time: zmanTime });
                } else {
                    console.warn(`Invalid Date for zman ${zman}: ${zmanTimeStr}`);
                }
            }
        });
    }

    // Add current time to the list
    zmanimList.push({ name: 'Current Time', time: currentTime });

    // Sort Zmanim list by time (compare actual time objects)
    zmanimList.sort((a, b) => a.time - b.time);

    // Display sorted Zmanim including current time
    zmanimList.forEach(({ name, time }) => {
        const zmanItem = document.createElement('div');
        zmanItem.className = 'zmanim-item';

        const zmanName = document.createElement('div');
        zmanName.className = 'zmanim-name';
        zmanName.textContent = name;

        const formattedTime = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const zmanTimeDiv = document.createElement('div');
        zmanTimeDiv.className = 'zmanim-time';
        zmanTimeDiv.textContent = formattedTime;

        // If it's the current time, highlight it
        if (name === 'Current Time') {
            zmanItem.classList.add('current-time-marker');
        } else if (currentTime > time) {
            // Grey out past times
            zmanItem.style.color = 'grey';
        }

        zmanItem.appendChild(zmanName);
        zmanItem.appendChild(zmanTimeDiv);

        resultsContainer.appendChild(zmanItem);
    });
}

        document.getElementById('zmanim-today-btn').addEventListener('click', async () => {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude.toFixed(4);
            const lng = position.coords.longitude.toFixed(4);
            const today = new Date().toISOString().split('T')[0]; // Current date in yyyy-mm-dd format

            console.log(`Fetching Zmanim for today's date (${today}) at current location: ${lat}, ${lng}`);

            try {
                // Fetch Zmanim data for current location
                const zmanimData = await fetchZmanimForLocation(lat, lng, today, today);

                // Fetch reverse geocoded city name
                const cityName = await getCityFromLatLong(lat, lng);
                const locationLabel = `${lat}, ${lng} (${cityName})`;

                // Display Zmanim in the new container
                displayTodayZmanim(zmanimData, locationLabel, today);

            } catch (error) {
                console.error("Error fetching Zmanim for current location:", error);
                document.getElementById('today-zmanim-results').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }, (error) => {
            console.error("Error getting current location:", error);
            document.getElementById('today-zmanim-results').innerHTML = `<p>Error getting location: ${error.message}</p>`;
        });
    } else {
        console.warn("Geolocation is not supported by this browser.");
        document.getElementById('today-zmanim-results').innerHTML = '<p>Geolocation not supported by your browser.</p>';
    }
});

const stateCapitals = [
    { name: "Montgomery", state: "Alabama", lat: 32.3668, lng: -86.3000, zip: "36104" },
    { name: "Juneau", state: "Alaska", lat: 58.3019, lng: -134.4197, zip: "99801" },
    { name: "Phoenix", state: "Arizona", lat: 33.4484, lng: -112.0740, zip: "85001" },
    { name: "Little Rock", state: "Arkansas", lat: 34.7465, lng: -92.2896, zip: "72201" },
    { name: "Sacramento", state: "California", lat: 38.5816, lng: -121.4944, zip: "94203" },
    { name: "Denver", state: "Colorado", lat: 39.7392, lng: -104.9903, zip: "80201" },
    { name: "Hartford", state: "Connecticut", lat: 41.7658, lng: -72.6734, zip: "06103" },
    { name: "Dover", state: "Delaware", lat: 39.1582, lng: -75.5244, zip: "19901" },
    { name: "Tallahassee", state: "Florida", lat: 30.4383, lng: -84.2807, zip: "32301" },
    { name: "Atlanta", state: "Georgia", lat: 33.7490, lng: -84.3880, zip: "30301" },
    { name: "Honolulu", state: "Hawaii", lat: 21.3069, lng: -157.8583, zip: "96813" },
    { name: "Boise", state: "Idaho", lat: 43.6150, lng: -116.2023, zip: "83701" },
    { name: "Springfield", state: "Illinois", lat: 39.7989, lng: -89.6446, zip: "62701" },
    { name: "Indianapolis", state: "Indiana", lat: 39.7684, lng: -86.1581, zip: "46204" },
    { name: "Des Moines", state: "Iowa", lat: 41.5868, lng: -93.6250, zip: "50309" },
    { name: "Topeka", state: "Kansas", lat: 39.0481, lng: -95.6771, zip: "66603" },
    { name: "Frankfort", state: "Kentucky", lat: 38.2009, lng: -84.8733, zip: "40601" },
    { name: "Baton Rouge", state: "Louisiana", lat: 30.4515, lng: -91.1871, zip: "70801" },
    { name: "Augusta", state: "Maine", lat: 44.3106, lng: -69.7795, zip: "04330" },
    { name: "Annapolis", state: "Maryland", lat: 38.9784, lng: -76.4922, zip: "21401" },
    { name: "Boston", state: "Massachusetts", lat: 42.3601, lng: -71.0589, zip: "02108" },
    { name: "Lansing", state: "Michigan", lat: 42.7325, lng: -84.5555, zip: "48933" },
    { name: "Saint Paul", state: "Minnesota", lat: 44.9537, lng: -93.0900, zip: "55101" },
    { name: "Jackson", state: "Mississippi", lat: 32.2988, lng: -90.1848, zip: "39201" },
    { name: "Jefferson City", state: "Missouri", lat: 38.5767, lng: -92.1735, zip: "65101" },
    { name: "Helena", state: "Montana", lat: 46.5891, lng: -112.0391, zip: "59601" },
    { name: "Lincoln", state: "Nebraska", lat: 40.8136, lng: -96.7026, zip: "68508" },
    { name: "Carson City", state: "Nevada", lat: 39.1638, lng: -119.7674, zip: "89701" },
    { name: "Concord", state: "New Hampshire", lat: 43.2081, lng: -71.5376, zip: "03301" },
    { name: "Trenton", state: "New Jersey", lat: 40.2206, lng: -74.7597, zip: "08608" },
    { name: "Santa Fe", state: "New Mexico", lat: 35.6869, lng: -105.9378, zip: "87501" },
    { name: "Albany", state: "New York", lat: 42.6526, lng: -73.7562, zip: "12207" },
    { name: "Raleigh", state: "North Carolina", lat: 35.7796, lng: -78.6382, zip: "27601" },
    { name: "Bismarck", state: "North Dakota", lat: 46.8083, lng: -100.7837, zip: "58501" },
    { name: "Columbus", state: "Ohio", lat: 39.9612, lng: -82.9988, zip: "43215" },
    { name: "Oklahoma City", state: "Oklahoma", lat: 35.4676, lng: -97.5164, zip: "73102" },
    { name: "Salem", state: "Oregon", lat: 44.9429, lng: -123.0351, zip: "97301" },
    { name: "Harrisburg", state: "Pennsylvania", lat: 40.2732, lng: -76.8867, zip: "17101" },
    { name: "Providence", state: "Rhode Island", lat: 41.8240, lng: -71.4128, zip: "02903" },
    { name: "Columbia", state: "South Carolina", lat: 34.0007, lng: -81.0348, zip: "29201" },
    { name: "Pierre", state: "South Dakota", lat: 44.3683, lng: -100.3510, zip: "57501" },
    { name: "Nashville", state: "Tennessee", lat: 36.1627, lng: -86.7816, zip: "37219" },
    { name: "Austin", state: "Texas", lat: 30.2672, lng: -97.7431, zip: "78701" },
    { name: "Salt Lake City", state: "Utah", lat: 40.7608, lng: -111.8910, zip: "84101" },
    { name: "Montpelier", state: "Vermont", lat: 44.2601, lng: -72.5754, zip: "05602" },
    { name: "Richmond", state: "Virginia", lat: 37.5407, lng: -77.4360, zip: "23219" },
    { name: "Olympia", state: "Washington", lat: 47.0379, lng: -122.9007, zip: "98501" },
    { name: "Charleston", state: "West Virginia", lat: 38.3498, lng: -81.6326, zip: "25301" },
    { name: "Madison", state: "Wisconsin", lat: 43.0731, lng: -89.4012, zip: "53703" },
    { name: "Cheyenne", state: "Wyoming", lat: 41.1400, lng: -104.8202, zip: "82001" }
];


async function generateLeaderboard() {
    const selectedZmanim = Array.from(document.querySelectorAll('input[name="zmanim"]:checked')).map(cb => cb.value);

    if (selectedZmanim.length === 0) {
        alert("Please select at least one Zman.");
        return;
    }

    const leaderboardContainer = document.getElementById('leaderboard-results');
    leaderboardContainer.innerHTML = ''; // Clear previous results

    // Clear existing markers from the map
    leaderboardMap.eachLayer(layer => {
        if (layer instanceof L.CircleMarker) {
            leaderboardMap.removeLayer(layer);
        }
    });

    for (const zman of selectedZmanim) {
        const leaderboardData = [];

        // Fetch Zmanim for each state capital
        for (const capital of stateCapitals) {
            const zmanimData = await fetchZmanimForLocation(capital.lat, capital.lng);

            if (zmanimData.times[zman]) {
                // Access the first date in the Zman object
                const zmanTimeStr = Object.values(zmanimData.times[zman])[0];
                const zmanTime = new Date(zmanTimeStr);

                leaderboardData.push({
                    zman: zman,
                    city: capital.name,
                    state: capital.state,
                    time: zmanTime,
                    zip: capital.zip,
                    timezone: zmanimData.location?.tzid || 'UTC',
                    lat: capital.lat,
                    lng: capital.lng
                });
            }
        }

        // Sort leaderboard data by local time
        leaderboardData.sort((a, b) => {
            const aTime = new Date(a.time.toLocaleString('en-US', { timeZone: a.timezone }));
            const bTime = new Date(b.time.toLocaleString('en-US', { timeZone: b.timezone }));
            return aTime - bTime;
        });

        // Create a new table for each Zman
        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Zman (${formatZmanName(zman)})</th>
                    <th>City</th>
                    <th>Time</th>
                    <th>Timezone</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');

        leaderboardData.forEach(item => {
            const formattedTime = item.time.toLocaleTimeString('en-US', {
                timeZone: item.timezone,
                hour: '2-digit',
                minute: '2-digit'
            });

            const row = `
                <tr>
                    <td>${formatZmanName(item.zman)}</td>
                    <td>${item.city}, ${item.state} (ZIP: ${item.zip})</td>
                    <td>${formattedTime}</td>
                    <td>${item.timezone}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        leaderboardContainer.appendChild(table); // Append each new table to the leaderboard container

        // Add markers to the map
        addMarkersToMap(leaderboardData);
    }
}

document.getElementById('fetch-leaderboard').addEventListener('click', generateLeaderboard);

document.addEventListener("DOMContentLoaded", function () {
    window.leaderboardMap = L.map('leaderboard-map').setView([39.8283, -98.5795], 4); // Center on the USA
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors'
    }).addTo(leaderboardMap);

    // Add a legend to the map
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'info legend');
        const grades = ['Early', 'Late'];
        const colors = ['#00ff00', '#ff0000']; // Green to Red

        // Loop through our grades and generate a label with a colored square for each grade
        div.innerHTML = '<strong>Zman Time</strong><br>';
        for (let i = 0; i < grades.length; i++) {
            div.innerHTML += `<i style="background:${colors[i]}"></i> ${grades[i]}<br>`;
        }

        return div;
    };
    legend.addTo(leaderboardMap);
});

function addMarkersToMap(leaderboardData) {
    // Calculate min and max Zmanim times for color gradient
    const minTime = Math.min(...leaderboardData.map(item => item.time.getTime()));
    const maxTime = Math.max(...leaderboardData.map(item => item.time.getTime()));

    // Define color gradient function based on Zmanim time
    function getColorForTime(time) {
        const ratio = (time.getTime() - minTime) / (maxTime - minTime);
        const hue = (1 - ratio) * 120; // Green (early) to red (late)
        return `hsl(${hue}, 100%, 50%)`;
    }

    leaderboardData.forEach(item => {
        const color = getColorForTime(item.time);

        const marker = L.circleMarker([item.lat, item.lng], {
            radius: 8,
            fillColor: color,
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(leaderboardMap);

        marker.bindPopup(`
            <b>${item.city}, ${item.state}</b><br>
            Zman: ${item.zman}<br>
            Time: ${item.time.toLocaleTimeString('en-US', { timeZone: item.timezone })}
        `);
    });
}



    </script>
</body>
</html>
